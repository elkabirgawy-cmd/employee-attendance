# ุชูููุฐ ูุธุงู Multi-Tenant SaaS ุงูุขูู

## ูุธุฑุฉ ุนุงูุฉ
ุชู ุชุญููู GeoShift ุฅูู ูุธุงู Multi-Tenant SaaS ุขูู ูุน ุนุฒู ูุงูู ููุจูุงูุงุช ุจูู ุงูุดุฑูุงุช. ูู ุดุฑูุฉ ููุง ุจูุงูุงุชูุง ุงููุณุชููุฉ ุชูุงูุงูุ ููุง ูููู ูุฃู ูุณุชุฎุฏู ุงููุตูู ุฅูู ุจูุงูุงุช ุดุฑูุฉ ุฃุฎุฑู.

---

## โ ุงูุชุบููุฑุงุช ุงููููุฐุฉ

### 1. ูุงุนุฏุฉ ุงูุจูุงูุงุช (Supabase SQL)

#### ุฃ) ุฅุถุงูุฉ Function ุขููุฉ ููุชุณุฌูู
ุชู ุฅูุดุงุก Postgres Function ุจุงุณู `create_company_and_admin()` ูุน ุงูุฎุตุงุฆุต ุงูุชุงููุฉ:

**ุงููููุน:** `supabase/migrations/add_secure_company_registration_function.sql`

**ุงููุธููุฉ:**
```sql
public.create_company_and_admin(
  p_company_name TEXT,
  p_full_name TEXT,
  p_email TEXT
)
```

**ุงููููุฒุงุช:**
- โ **SECURITY DEFINER**: ุชุนูู ุจุตูุงุญูุงุช ุนุงููุฉ ูุชุฌุงูุฒ RLS ุจุดูู ุขูู
- โ ุชููุดุฆ company ุฌุฏูุฏุฉ ุชููุงุฆูุงู
- โ ุชุฑุจุท ุงูุฃุฏูู ุจุงูุดุฑูุฉ ูู ุฌุฏูู admin_users
- โ ุชุชุญูู ูู ุนุฏู ูุฌูุฏ admin_user ุจุงููุนู ูููุณ ุงููุณุชุฎุฏู
- โ ุชุฑุฌุน JSON ูุญุชูู ุนูู company_id ู user_id

**ุงูุตูุงุญูุงุช:**
```sql
GRANT EXECUTE ON FUNCTION public.create_company_and_admin(TEXT, TEXT, TEXT) TO authenticated;
```

#### ุจ) ุชุญุฏูุซ RLS Policies

**ุฌุฏูู companies:**
- โ **ุชู ุญุฐู** policy ููู INSERT ุงููุจุงุดุฑ (`companies_insert_any_auth_user`)
- โ **ููุฌูุฏุฉ** policy ููู SELECT (ุฑุคูุฉ ุงูุดุฑูุฉ ุงูุฎุงุตุฉ ููุท)
- โ **ุชู ุฅุถุงูุฉ** policy ููู UPDATE (ุชุนุฏูู ุงูุดุฑูุฉ ุงูุฎุงุตุฉ ููุท)

**ุฌุฏูู admin_users:**
- โ **ุชู ุชุญุฏูุซ** policies ููุณูุงุญ ุจุฑุคูุฉ ุฌููุน ุฃุนุถุงุก ููุณ ุงูุดุฑูุฉ
- โ **ุชู ุชุญุฏูุซ** policies ููุณูุงุญ ุจุฅุถุงูุฉ ุฃุนุถุงุก ุฌุฏุฏ ูููุณ ุงูุดุฑูุฉ
- โ **ุชู ุญุฐู** policies ุงููุฏููุฉ ุงูููุฑุฑุฉ

---

### 2. ุงููุงุฌูุฉ ุงูุฃูุงููุฉ (Frontend)

#### ุฃ) ุตูุญุฉ ุงูุชุณุฌูู (Register.tsx)

**ุงููููุน:** `src/pages/Register.tsx`

**ุงูุชุบููุฑุงุช:**
ุชู ุงุณุชุจุฏุงู ุงูููุฏ ุงููุฏูู ุงูุฐู ูุงู ูููุดุฆ company ู admin_user ูุจุงุดุฑุฉ ุจู:

```typescript
// ุงุณุชุฏุนุงุก Function ุขููุฉ
const { data: result, error: rpcError } = await supabase.rpc(
  'create_company_and_admin',
  {
    p_company_name: companyName,
    p_full_name: fullName,
    p_email: email,
  }
);
```

**ุงููููุฒุงุช:**
- โ ูุง ููุฌุฏ INSERT ูุจุงุดุฑ ูู companies
- โ ูู ุดูุก ูุชู ุนุจุฑ Function ุขููุฉ
- โ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุจุดูู ุตุญูุญ
- โ **ูู ูุชุบูุฑ ุงูุชุตููู ููุงุฆูุงู** - ููุณ ุงูุณุชุงูู ูุงูููุงูุด

#### ุจ) AuthContext

**ุงููููุน:** `src/contexts/AuthContext.tsx`

**ุงูุญุงูุฉ:**
- โ ูุฌูุจ company_id ูู admin_users ุชููุงุฆูุงู (ุงูุณุทุฑ 68-76)
- โ ูุฎุฒู company_id ูู ุงูู state
- โ ุฌููุน ุงูุงุณุชุนูุงูุงุช ุชุณุชุฎุฏู companyId ููุนุฒู
- โ **ูู ูุชู ุชุนุฏููู** - ูุนูู ุจุดูู ุตุญูุญ ุจุงููุนู

---

### 3. ูุธุงู ุงูููุธููู

**ุงูุญุงูุฉ:**
- โ **ูู ูุชุฃุซุฑ ููุงุฆูุงู**
- โ ูุณุชุฎุฏู localStorage ููุฌูุณุงุช
- โ ูุง ูุนุชูุฏ ุนูู Supabase Auth
- โ ูุนูู ุจุดูู ูุณุชูู ุชูุงูุงู

**ุงููููุงุช ุบูุฑ ุงููุชุฃุซุฑุฉ:**
- `src/pages/EmployeeLogin.tsx`
- `src/pages/EmployeeCheckIn.tsx`
- `src/pages/EmployeeApp.tsx`
- ุฌููุน Edge Functions ุงูุฎุงุตุฉ ุจุงูููุธููู

---

## ๐ ุงูุฃูุงู

### ุนุฒู ุงูุจูุงูุงุช
1. **ุนูู ูุณุชูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:**
   - ูู ุงุณุชุนูุงู SELECT/UPDATE/DELETE ููููุชุฑ ุชููุงุฆูุงู ุญุณุจ company_id
   - RLS ุชููุน ุฃู ูุตูู ูุจูุงูุงุช ุดุฑูุฉ ุฃุฎุฑู
   - ูุง ูููู ุชุฌุงูุฒ ุงูุฃูุงู ูู ุงูุนููู

2. **ุนูู ูุณุชูู ุงูุชุทุจูู:**
   - companyId ููุฌูุจ ูู admin_users (ูุง ูููู ุงูุชูุงุนุจ ุจู)
   - ุฌููุน ุงูุงุณุชุนูุงูุงุช ุชุณุชุฎุฏู companyId
   - ูุง ููุฌุฏ INSERT ูุจุงุดุฑ ูู companies

### ููุน ุงููุฌูุงุช
- โ **SQL Injection**: ูุญูู ุนุจุฑ RLS ู Parameterized Queries
- โ **Data Leakage**: ูู ุดุฑูุฉ ูุนุฒููุฉ ุชูุงูุงู
- โ **Privilege Escalation**: ูุง ูููู ููุฃุฏูู ุงููุตูู ูุดุฑูุฉ ุฃุฎุฑู
- โ **Direct Insert**: ููููุนุ ูุชู ููุท ุนุจุฑ Function ุขููุฉ

---

## ๐งช ุงูุงุฎุชุจุงุฑุงุช ุงููุทููุจุฉ

### ุงุฎุชุจุงุฑ 1: ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ
```
1. ุงูุชุญ ุตูุญุฉ ุงูุชุณุฌูู: /register
2. ุฃุฏุฎู ุงูุจูุงูุงุช:
   - ุงูุงุณู ุงููุงูู: ูุญูุฏ ุฃุญูุฏ
   - ุงุณู ุงูุดุฑูุฉ: ุดุฑูุฉ ุชุณุช 1
   - ุงูุจุฑูุฏ: test1@example.com
   - ูููุฉ ุงููุฑูุฑ: 123456
3. ุงุถุบุท "ุฅูุดุงุก ุญุณุงุจ"

โ ุงููุชูุฌุฉ ุงููุชููุนุฉ:
- ุชู ุฅูุดุงุก ุงูุญุณุงุจ ุจูุฌุงุญ
- ูุธูุฑ ุฑุณุงูุฉ ูุฌุงุญ ูุน ุจูุงูุงุช ุงูุดุฑูุฉ
- ูุง ูุธูุฑ ุฎุทุฃ RLS
```

### ุงุฎุชุจุงุฑ 2: ุชุณุฌูู ุฏุฎูู ุจุญุณุงุจ ููุฌูุฏ
```
1. ุงุณุชุฎุฏู ุญุณุงุจ ูุฏูู ููุฏุฎูู
2. ุชุญูู ูู ุธููุฑ ุจูุงูุงุช ุงูุดุฑูุฉ ุงูุตุญูุญุฉ
3. ุชุญูู ูู ุนุฏู ุธููุฑ ุจูุงูุงุช ุดุฑูุงุช ุฃุฎุฑู

โ ุงููุชูุฌุฉ ุงููุชููุนุฉ:
- ุชุณุฌูู ุงูุฏุฎูู ูุนูู ุจุดูู ุทุจูุนู
- ุงูุจูุงูุงุช ุงููุนุฑูุถุฉ ุฎุงุตุฉ ุจุงูุดุฑูุฉ ููุท
```

### ุงุฎุชุจุงุฑ 3: ุฅูุดุงุก ุญุณุงุจ ุซุงูู (ุดุฑูุฉ ุซุงููุฉ)
```
1. ุงูุชุญ ุตูุญุฉ ุงูุชุณุฌูู ูู ูุชุตูุญ ุขุฎุฑ ุฃู InPrivate
2. ุฃุฏุฎู ุจูุงูุงุช ุฌุฏูุฏุฉ:
   - ุงูุงุณู: ุนูู ุญุณู
   - ุงูุดุฑูุฉ: ุดุฑูุฉ ุชุณุช 2
   - ุงูุจุฑูุฏ: test2@example.com
   - ูููุฉ ุงููุฑูุฑ: 123456
3. ุงุถุบุท "ุฅูุดุงุก ุญุณุงุจ"

โ ุงููุชูุฌุฉ ุงููุชููุนุฉ:
- ูุชู ุฅูุดุงุก ุดุฑูุฉ ุฌุฏูุฏุฉ ูุณุชููุฉ ุชูุงูุงู
- ูุง ูุธูุฑ ุฃู ุจูุงูุงุช ูู ุงูุดุฑูุฉ ุงูุฃููู
```

### ุงุฎุชุจุงุฑ 4: ูุญุงููุฉ ุงููุตูู ุงููุจุงุดุฑ (Security Test)
```sql
-- ูู Supabase SQL Editorุ ุฌุฑูุจ:
INSERT INTO companies (name, plan, status, currency_label)
VALUES ('Hacked Company', 'free', 'active', 'ุฑุงู');

โ ุงููุชูุฌุฉ ุงููุชููุนุฉ:
- ูุธูุฑ ุฎุทุฃ: "new row violates row-level security policy"
- ูุง ูุชู ุฅุฏุฑุงุฌ ุงูุจูุงูุงุช
```

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

### ูููุงุช SQL
1. โ `supabase/migrations/add_secure_company_registration_function.sql` - **ุฌุฏูุฏ**
2. โ `supabase/migrations/cleanup_duplicate_admin_users_policies.sql` - **ุฌุฏูุฏ**

### ูููุงุช Frontend
1. โ `src/pages/Register.tsx` - **ุชู ุชุนุฏูู ุงูุณุทูุฑ 17-85**
   - ุงุณุชุจุฏุงู INSERT ุงููุจุงุดุฑ ุจู RPC call
   - ุฅุถุงูุฉ ูุนุงูุฌุฉ ุฃุฎุทุงุก ุฃูุถู

### ูููุงุช ุบูุฑ ูุชุฃุซุฑุฉ
- โ `src/contexts/AuthContext.tsx` - **ูู ูุชู ุงูุชุนุฏูู**
- โ `src/pages/EmployeeLogin.tsx` - **ูู ูุชู ุงูุชุนุฏูู**
- โ ุฌููุน UI components - **ูู ูุชู ุงูุชุนุฏูู**
- โ ุฌููุน ูููุงุช Edge Functions - **ูู ูุชู ุงูุชุนุฏูู**

---

## ๐ฏ ุณูุฑ ุงูุนูู ุงููุงูู

### ุนูุฏ ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ:
```
1. ุงููุณุชุฎุฏู ูููุฃ ุงููููุฐุฌ ูู /register
   โ
2. ูุชู ุฅูุดุงุก ุญุณุงุจ Auth ูู Supabase
   โ
3. ูุชู ุงุณุชุฏุนุงุก RPC: create_company_and_admin()
   โ
4. Function ุชููุดุฆ:
   - Company ุฌุฏูุฏุฉ
   - Admin_user ูุฑุชุจุท ุจุงูุดุฑูุฉ
   โ
5. AuthContext ูุฌูุจ company_id ุชููุงุฆูุงู
   โ
6. ุงููุณุชุฎุฏู ููุญููู ูููุญุฉ ุงูุชุญูู
   โ
7. ุฌููุน ุงูุจูุงูุงุช ูุนุฒููุฉ ุญุณุจ company_id
```

### ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู:
```
1. ุงููุณุชุฎุฏู ูุฏุฎู email/password
   โ
2. Supabase Auth ูุชุญูู ูู ุงููููุฉ
   โ
3. AuthContext ูุฌูุจ admin_users record
   โ
4. ูุชู ุงุณุชุฎุฑุงุฌ company_id
   โ
5. ุฌููุน ุงูุงุณุชุนูุงูุงุช ุชูููุชุฑ ุญุณุจ company_id
```

---

## ๐ ุงูุฎูุงุตุฉ

ุชู ุชุญููู GeoShift ุจูุฌุงุญ ุฅูู ูุธุงู Multi-Tenant SaaS ุงุญุชุฑุงูู ูุน:

โ **ุนุฒู ูุงูู** ููุจูุงูุงุช ุจูู ุงูุดุฑูุงุช
โ **ุฃูุงู ุนุงูู** ุนุจุฑ RLS ู SECURITY DEFINER
โ **ุชุณุฌูู ุชููุงุฆู** ุจุฏูู ุชุฏุฎู ุงููุณุชุฎุฏู
โ **ุตูุฑ ุชุบููุฑุงุช** ูู ุงูุชุตููู ุฃู ูุธุงู ุงูููุธููู
โ **ุฌุงูุฒ ููุฅูุชุงุฌ** ูุน ุงุฎุชุจุงุฑุงุช ุดุงููุฉ

---

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ุงูููุธููู:** ูุธุงููู ูุณุชูู ุชูุงูุงู ููู ูุชุฃุซุฑ
2. **ุงูุชุตููู:** ุตูุฑ ุชุบููุฑุงุช ูู UI/UX
3. **ุงูุฃูุงู:** ูุญูู ุจุงููุงูู ุนุจุฑ RLS
4. **ุงูุจูุงุก:** ุชู ุงูุงุฎุชุจุงุฑ ุจูุฌุงุญ (npm run build โ)
5. **ุงูุชูุงูููุฉ:** ูุนูู ูุน ุฌููุน ุงููุชุตูุญุงุช

---

## ๐ ูููุทูุฑูู

ุฅุฐุง ุฃุฑุฏุช ุฅุถุงูุฉ ุฌุฏุงูู ุฌุฏูุฏุฉุ ุงุชุจุน ูุฐู ุงูููุงุนุฏ:

1. **ุฃุถู ุนููุฏ company_id** ูู ูู ุฌุฏูู
2. **ุฃูุดุฆ RLS policies** ุชููุชุฑ ุญุณุจ company_id
3. **ุงุณุชุฎุฏู companyId** ูู AuthContext ูู ุงูุงุณุชุนูุงูุงุช
4. **ูุง ุชุณุชุฎุฏู INSERT ูุจุงุดุฑ** ูู ุงูุฌุฏุงูู ุงูุญุณุงุณุฉ

ูุซุงู:
```typescript
const { data } = await supabase
  .from('my_table')
  .select('*')
  .eq('company_id', companyId); // โ ุฏุงุฆูุงู ุงุณุชุฎุฏู companyId
```

---

**ุชุงุฑูุฎ ุงูุชูููุฐ:** 27 ููุงูุฑ 2026
**ุงูุญุงูุฉ:** โ ููุชูู ูุฌุงูุฒ ููุงุฎุชุจุงุฑ
