# نظام المكافآت - دليل التنفيذ الكامل

## نظرة عامة
تم تنفيذ نظام المكافآت بشكل كامل ومتكامل مع نظام الجزاءات الموجود. يستخدم النظام نفس جدول `penalties` مع حقل `impact` لتمييز المكافآت ('positive') عن الجزاءات ('negative').

---

## 1. قاعدة البيانات

### الجدول: `penalties`
الحقول المضافة/المحدثة:
- `impact`: text ('positive' للمكافآت، 'negative' للجزاءات) ✓
- `penalty_type`: يدعم الآن الأنواع التالية:
  - `fixed_amount`: مبلغ ثابت (جديد)
  - `salary_percent`: نسبة من الراتب الأساسي (جديد)
  - `fixed`: مبلغ ثابت (قديم، للتوافق)
  - `fraction`: نسبة من الأجر اليومي (قديم، للتوافق)
  - `days`: أيام × الأجر اليومي
- `is_recurring`: boolean (افتراضي: false) ✓
- `apply_to_salary`: boolean (افتراضي: true) ✓

### الفهارس
```sql
CREATE INDEX idx_penalties_impact ON penalties(impact);
CREATE INDEX idx_penalties_employee_impact ON penalties(employee_id, impact);
CREATE INDEX idx_penalties_type_impact ON penalties(penalty_type, impact);
```

---

## 2. واجهة المستخدم

### تبويب المكافآت
- **الموقع**: بجانب تبويب "الجزاءات" في صفحة الرواتب
- **الأيقونة**: Gift (أخضر)
- **التصميم**: نفس تصميم الجزاءات تماماً مع اللون الأخضر

### نموذج إضافة مكافأة
**الحقول:**
1. **الموظف** (Dropdown):
   - قائمة منسدلة قابلة للبحث
   - يعرض جميع الموظفين النشطين

2. **التاريخ**:
   - حقل اختيار تاريخ
   - افتراضي: التاريخ الحالي

3. **نوع المكافأة**:
   - `fixed_amount`: مبلغ ثابت
   - `salary_percent`: نسبة من الراتب الأساسي

4. **القيمة**:
   - رقم موجب
   - لـ `fixed_amount`: المبلغ بالعملة
   - لـ `salary_percent`: النسبة المئوية (مثال: 10 = 10%)

5. **السبب** (اختياري):
   - حقل نصي متعدد الأسطر
   - وصف سبب المكافأة

**زر الإضافة:**
- "إضافة مكافأة" (أخضر)
- يضيف المكافأة بحالة "قيد الانتظار"

### قائمة المكافآت
- عرض جميع المكافآت مع الحالات:
  - ⏳ قيد الانتظار (Pending)
  - ✅ معتمد (Approved)
  - ❌ مرفوض (Rejected)
- أزرار الموافقة/الرفض للمسؤولين
- فلترة حسب الموظف والحالة

---

## 3. منطق الحساب

### دالة `calculatePenaltyDeduction`
```typescript
function calculatePenaltyDeduction(
  penalty: Penalty,
  dailyRate: number,
  baseSalary?: number
): number
```

**منطق الحساب:**

1. **fixed_amount / fixed**:
   ```
   القيمة = penalty_value
   ```

2. **salary_percent**:
   ```
   القيمة = (penalty_value / 100) × baseSalary
   ```
   مثال: نسبة 10% من راتب 5000 = 500

3. **fraction** (للتوافق):
   ```
   القيمة = penalty_value × dailyRate
   ```

4. **days** (للتوافق):
   ```
   القيمة = penalty_value × dailyRate
   ```

### تأثير على الراتب

**المعادلة الكاملة:**
```
الراتب الأساسي = monthly_salary أو (daily_wage × present_days)
إجمالي المستحقات = الراتب الأساسي + البدلات
المكافآت = مجموع المكافآت المعتمدة في الفترة
الإضافي = overtime_amount
الخصومات = الغياب + التأخير + الجزاءات + التأمينات + الضريبة

صافي الراتب = إجمالي المستحقات + الإضافي + المكافآت - الخصومات
```

---

## 4. العرض في كشف المرتب

### كارت الراتب
```
┌─────────────────────────────────────┐
│ المستحقات                           │
├─────────────────────────────────────┤
│ الراتب الأساسي:      5,000.00     │
│ البدلات:               500.00      │
│ الإضافي:               200.00      │
│ المكافآت:              300.00  ✓   │  ← أخضر (+)
├─────────────────────────────────────┤
│ الإجمالي:            6,000.00      │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ الخصومات                            │
├─────────────────────────────────────┤
│ الغياب:              -100.00       │
│ التأخير:              -50.00       │
│ الجزاءات:            -150.00       │
│ التأمينات:           -250.00       │
│ الضريبة:             -100.00       │
├─────────────────────────────────────┤
│ الإجمالي:            -650.00       │
└─────────────────────────────────────┘

صافي الراتب: 5,350.00
```

### الشروط
- يظهر سطر المكافآت **فقط** إذا كانت القيمة > 0
- اللون: أخضر (#10b981)
- الرمز: علامة (+) قبل القيمة

---

## 5. تصدير PDF

### المكونات المحدثة

1. **PayrollCardCompact**:
   - يعرض المكافآت في قسم المستحقات
   - لون أخضر للتمييز

2. **PayrollCardPrintA4**:
   - نفس العرض للطباعة
   - يحافظ على التنسيق

3. **printPayrollCardToPDF**:
   - يتضمن المكافآت في التصدير
   - يحسب الإجمالي الصحيح

### مثال على PDF
```
========================================
        كشف المرتب - يناير 2026
========================================

الموظف: أحمد محمد
الكود: EMP001

----------------------------------------
المستحقات:
----------------------------------------
الراتب الأساسي          5,000.00 جنيه
البدلات                   500.00 جنيه
الإضافي                   200.00 جنيه
المكافآت                  300.00 جنيه  ← جديد
                        ──────────────
الإجمالي                6,000.00 جنيه

----------------------------------------
الخصومات:
----------------------------------------
الغياب                   -100.00 جنيه
التأخير                   -50.00 جنيه
الجزاءات                 -150.00 جنيه
التأمينات                -250.00 جنيه
الضريبة                  -100.00 جنيه
                        ──────────────
الإجمالي                 -650.00 جنيه

========================================
صافي الراتب            5,350.00 جنيه
========================================
```

---

## 6. أمثلة الاستخدام

### مثال 1: مكافأة مبلغ ثابت
```
الموظف: أحمد محمد
النوع: fixed_amount
القيمة: 500
السبب: تميز في الأداء

النتيجة: يضاف 500 جنيه للراتب
```

### مثال 2: مكافأة نسبة من الراتب
```
الموظف: محمد علي
الراتب الأساسي: 5,000
النوع: salary_percent
القيمة: 10
السبب: مكافأة نهاية العام

الحساب: 10% × 5,000 = 500
النتيجة: يضاف 500 جنيه للراتب
```

### مثال 3: مكافآت متعددة
```
المكافأة 1: fixed_amount = 300
المكافأة 2: salary_percent (10% من 5,000) = 500
المجموع: 800 جنيه يضاف للراتب
```

---

## 7. قواعد العمل

### التوقيت
- المكافآت **غير متكررة** افتراضياً (`is_recurring: false`)
- تُحسب فقط في الفترة التي تقع فيها
- لا تؤثر على الأشهر الأخرى

### الموافقات
- جميع المكافآت تبدأ بحالة "قيد الانتظار"
- يجب موافقة المسؤول لتطبيقها
- المكافآت المرفوضة لا تظهر في الحسابات

### الأمان
- فقط المدراء المصرح لهم يمكنهم:
  - إضافة مكافآت
  - الموافقة/الرفض
  - عرض قائمة المكافآت
- سياسات RLS تطبق نفس قواعد الجزاءات

---

## 8. الملفات المعدلة

### قاعدة البيانات
- `supabase/migrations/20260130114218_add_bonuses_impact_field.sql`
- `supabase/migrations/20260130114653_add_bonuses_amount_to_payroll_runs.sql`
- `supabase/migrations/[new]_unify_penalty_bonus_types.sql`

### TypeScript/React
- `src/pages/Payroll.tsx` - واجهة المكافآت والجزاءات
- `src/utils/payrollCalculations.ts` - منطق الحساب
- `src/components/PayrollCardCompact.tsx` - عرض الكارت
- `src/components/PayrollCardPrintA4.tsx` - نسخة الطباعة
- `src/components/EmployeePayrollDetailsModal.tsx` - نافذة التفاصيل
- `src/utils/printPayrollCardToPDF.ts` - تصدير PDF

---

## 9. الاختبار

### سيناريوهات الاختبار

1. **إضافة مكافأة مبلغ ثابت**
   - أضف مكافأة 500 جنيه لموظف
   - تحقق من ظهورها في قائمة المكافآت
   - وافق عليها
   - احسب الراتب وتحقق من الإضافة

2. **إضافة مكافأة نسبة**
   - أضف مكافأة 10% لموظف براتب 5000
   - تحقق من حساب 500 جنيه تلقائياً
   - احسب الراتب وتحقق من الصحة

3. **عرض في كشف المرتب**
   - احسب راتب موظف له مكافآت
   - تحقق من ظهور سطر المكافآت بلون أخضر
   - تحقق من الحساب الصحيح للصافي

4. **تصدير PDF**
   - صدّر كشف مرتب يحتوي على مكافآت
   - تحقق من وجود سطر المكافآت
   - تحقق من التنسيق والألوان

---

## 10. الملاحظات المهمة

1. **التوافق للخلف**: النظام يدعم الأنواع القديمة (fixed, fraction, days) والجديدة (fixed_amount, salary_percent)

2. **عدم التكرار**: الحقول الجديدة (`is_recurring`, `apply_to_salary`) جاهزة للاستخدام المستقبلي

3. **الأداء**: تم إضافة فهارس لتسريع الاستعلامات

4. **الأمان**: نفس سياسات RLS المطبقة على الجزاءات تطبق على المكافآت

5. **UI/UX**: التصميم متسق تماماً مع الجزاءات مع تمييز اللون الأخضر

---

## التحقق من النجاح ✅

- [✓] جدول قاعدة البيانات محدث
- [✓] واجهة تبويب المكافآت
- [✓] نموذج إضافة مكافأة
- [✓] قائمة المكافآت مع الحالات
- [✓] منطق الحساب الصحيح
- [✓] العرض في كشف المرتب
- [✓] التصدير إلى PDF
- [✓] التوافق مع الأنواع القديمة
- [✓] البناء بدون أخطاء

**الحالة**: جاهز للإنتاج ✨
